name: Download and prepare MAD-X sources
inputs:
  base:
    description: 'manylinux base image'
    required: true

runs:
  using: composite
  steps:
    - run: echo "MADX_VERSION=$(cat MADX_VERSION)" >> $GITHUB_ENV
      shell: bash

    - name: Download cached MAD-X build
      id: madx-build-cache
      uses: actions/cache@v3
      with:
        path: src/MAD-X/dist
        key: "\
          madx-${{ env.MADX_VERSION }}-\
          ${{ inputs.base }}-\
          patches-${{ hashFiles('.github/patch/*') }}-\
          scripts-${{ hashFiles('.github/build/linux/madx*') }}\
        "

    - name: Prepare MAD-X source
      if: steps.madx-build-cache.outputs.cache-hit != 'true'
      uses: ./.github/checkout-madx
      with:
        madx_version: ${{ env.MADX_VERSION }}

    - name: Set up QEMU for running arm64 containers
      if: endsWith(inputs.base, '_aarch64')
      uses: docker/setup-qemu-action@v2

    - name: Prepare docker image
      run: |
        docker buildx build .github/build/linux \
          --build-arg UID=`id -u` \
          --build-arg GID=`id -g` \
          --build-arg BASE=${{ inputs.base }} \
          -t builder
      shell: bash

    - name: Build MAD-X
      if: steps.madx-build-cache.outputs.cache-hit != 'true'
      run: |
        docker run --rm --init \
          -w /mnt \
          -v `pwd`:/mnt \
          builder \
          .github/build/linux/madx.sh src/MAD-X
      shell: bash

    - name: Build cpymad wheels
      run: |
        docker run --rm --init \
          -w /mnt \
          -v `pwd`:/mnt \
          builder \
          .github/build/linux/cpymad.sh src/MAD-X/dist
      shell: bash

    - name: Upload cpymad wheels
      uses: actions/upload-artifact@v3
      with:
        name: dist-linux
        path: dist
